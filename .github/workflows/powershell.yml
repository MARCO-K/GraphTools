# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
#
# https://github.com/microsoft/action-psscriptanalyzer
# For more information on PSScriptAnalyzer in general, see
# https://github.com/PowerShell/PSScriptAnalyzer

name: PSScriptAnalyzer

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '30 15 * * 5'

permissions:
  contents: read

jobs:
  build:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    name: PSScriptAnalyzer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache PowerShell modules
        uses: actions/cache@v4
        with:
          # Common module locations for PowerShell Core and older PowerShell paths to be robust.
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell/Modules
            ~/.powershell/Modules
            ~/Documents/PowerShell/Modules
          # Key is based on runner OS + module manifest; cache is invalidated only when module dependencies change.
          key: ${{ runner.os }}-pwsh-modules-${{ hashFiles('GraphTools.psd1') }}
          restore-keys: |
            ${{ runner.os }}-pwsh-modules-

      - name: Ensure PowerShell modules can be installed and install PSFramework
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Force TLS 1.2 for gallery access
          try {
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          } catch {
            Write-Host "Could not set TLS explicitly; continuing."
          }

          # Ensure NuGet provider is available (required by Install-Module on non-Windows)
          if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
            Install-PackageProvider -Name NuGet -Force -Scope CurrentUser
          }

          # Ensure PowerShellGet exists (Install-Module depends on it)
          if (-not (Get-Command -Name Install-Module -ErrorAction SilentlyContinue)) {
            Install-Module -Name PowerShellGet -Force -Scope CurrentUser -AllowClobber
          }

          # Make sure PSGallery is registered and trusted
          if (-not (Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue)) {
            Register-PSRepository -Name PSGallery -SourceLocation "https://www.powershellgallery.com/api/v2" -InstallationPolicy Trusted
          } else {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          }

          # Install the module into CurrentUser scope so no admin rights required
          Install-Module -Name PSFramework -Force -Scope CurrentUser -SkipPublisherCheck -AllowClobber

      - name: Run PSScriptAnalyzer
        uses: microsoft/psscriptanalyzer-action@6b2948b1944407914a58661c49941824d149734f
        with:
          # Check https://github.com/microsoft/action-psscriptanalyzer for more info about the options.
          # The below set up runs PSScriptAnalyzer to your entire repository and runs some basic security rules.
          path: ./
          recurse: true
          # Include your own basic security rules. Removing this option will run all the rules
          includeRule: '"PSAvoidGlobalAliases", "PSAvoidUsingConvertToSecureStringWithPlainText"'
          output: results.sarif

      # Upload the SARIF file generated in the previous step
      - name: Upload SARIF results file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
